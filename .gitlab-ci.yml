# SPDX-FileCopyrightText: 2026 Mattia Egloff <mattia.egloff@pm.me>
#
# SPDX-License-Identifier: GPL-3.0-or-later

# GitLab CI for vauchi-cli
#
# Command-line interface
#
# Performance optimizations:
#   - Change-based rules: Jobs run only when relevant files change
#   - Timeouts: Prevent runaway jobs from blocking runners
#   - Read-only cache for lint jobs
#
# Pipeline strategy:
#   - MR: Validation on relevant file changes
#   - Upstream trigger: Verify compatibility when core merges to main
#
# Uses shared templates from vauchi/scripts for consistency.

# Include shared templates
include:
  - project: 'vauchi/scripts'
    ref: main
    file:
      - '/ci-templates/rust-base.yml'
      - '/ci-templates/security.yml'
      - '/ci-templates/mr-rules.yml'
      - '/ci-templates/downstream.yml'
      - '/ci-templates/reuse.yml'

stages:
  - lint
  - test
  - security
  - verify

# Cross-repo git access: configure git to use CI_JOB_TOKEN for HTTPS
# requests and use system git (instead of libgit2) for cargo fetches.
# Required when Cargo.toml points to branches in other vauchi/* repos.
variables:
  CARGO_NET_GIT_FETCH_WITH_CLI: "true"

default:
  before_script:
    - git config --global url."https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.com/".insteadOf "https://gitlab.com/"

# ============================================================
# Lint Stage (runs on Rust code changes)
# ============================================================

lint:format:
  extends: [.rust-job, .validation-rust, .timeout-quick]
  stage: lint
  needs: []
  cache:
    policy: pull  # Read-only cache for lint
  script:
    - rustup component add rustfmt
    - cargo fmt --all -- --check

lint:clippy:
  extends: [.rust-job, .validation-rust, .timeout-quick]
  stage: lint
  needs: []
  cache:
    policy: pull  # Read-only cache for lint
  script:
    - rustup component add clippy
    - cargo clippy --all-targets -- -D warnings

# ============================================================
# Test Stage (runs on Rust code changes)
# ============================================================

test:coverage:
  extends: [.rust-job, .validation-rust, .timeout-standard]
  stage: test
  needs: []
  before_script:
    - git config --global url."https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.com/".insteadOf "https://gitlab.com/"
    - rustup component add llvm-tools-preview
    - cargo install cargo-llvm-cov --locked || true
  script:
    # Disable secure-storage (OS keychain) for CI â€” headless Linux has no
    # keyring daemon, so PlatformKeyring fails across subprocess invocations.
    # FileKeyStorage (the fallback) persists correctly in each test's TempDir.
    - cargo llvm-cov --all-targets --no-default-features --lcov --output-path lcov.info
    - cargo llvm-cov report --cobertura --output-path cobertura.xml
    - cargo llvm-cov report
  coverage: '/Total:\s+(\d+(?:\.\d+)?%)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: cobertura.xml
    paths:
      - lcov.info
      - cobertura.xml
    expire_in: 1 week

# ============================================================
# Security Stage (runs on dependency changes)
# ============================================================

security:audit:
  extends: [.rust-job, .validation-deps, .timeout-quick]
  stage: security
  needs: []
  cache:
    policy: pull  # Read-only cache
  script:
    - cargo install cargo-audit || true
    - cargo audit

# Full cargo-deny check: advisories, licenses, bans, sources
security:deny:
  extends: [.rust-job, .timeout-quick]
  stage: security
  needs: []
  cache:
    policy: pull
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_PIPELINE_SOURCE == "schedule"
  script:
    - cargo binstall cargo-deny --no-confirm 2>/dev/null || cargo install cargo-deny || true
    - cargo deny check

# ============================================================
# Verify Stage (upstream trigger only)
# ============================================================
# Runs when core merges to main and triggers this repo via
# verify:downstream-rust. Verifies this repo builds and tests
# pass against the updated vauchi-core.

verify:upstream-compat:
  extends: [.rust-job, .verify-on-upstream, .timeout-standard]
  stage: verify
  needs: []
  script:
    - cargo test --all-targets --no-default-features
