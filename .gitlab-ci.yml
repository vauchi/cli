# SPDX-FileCopyrightText: 2026 Mattia Egloff <mattia.egloff@pm.me>
#
# SPDX-License-Identifier: GPL-3.0-or-later

# GitLab CI for vauchi-cli
#
# Command-line interface
#
# Performance optimizations:
#   - Change-based rules: Jobs run only when relevant files change
#   - Timeouts: Prevent runaway jobs from blocking runners
#   - Read-only cache for lint jobs
#
# Pipeline strategy:
#   - MR: Validation on relevant file changes
#   - Main: No pipeline (validated via MR)
#
# Uses shared templates from vauchi/scripts for consistency.

# Include shared templates
include:
  - project: 'vauchi/scripts'
    ref: main
    file:
      - '/ci-templates/rust-base.yml'
      - '/ci-templates/security.yml'
      - '/ci-templates/mr-rules.yml'

stages:
  - lint
  - test
  - security

# ============================================================
# Local Template Definitions (until scripts MR is merged)
# ============================================================

.validation-rust:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "**/*.rs"
        - "**/Cargo.toml"
        - "**/Cargo.lock"
        - ".gitlab-ci.yml"

.validation-deps:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "**/Cargo.toml"
        - "**/Cargo.lock"
        - ".gitlab-ci.yml"

.timeout-quick:
  timeout: 10 minutes

.timeout-standard:
  timeout: 30 minutes

# ============================================================
# Lint Stage (runs on Rust code changes)
# ============================================================

lint:format:
  extends: [.rust-job, .validation-rust, .timeout-quick]
  stage: lint
  cache:
    policy: pull  # Read-only cache for lint
  script:
    - rustup component add rustfmt
    - cargo fmt --all -- --check

lint:clippy:
  extends: [.rust-job, .validation-rust, .timeout-quick]
  stage: lint
  cache:
    policy: pull  # Read-only cache for lint
  script:
    - rustup component add clippy
    - cargo clippy --all-targets -- -D warnings

# ============================================================
# Test Stage (runs on Rust code changes)
# ============================================================

test:unit:
  extends: [.rust-job, .validation-rust, .timeout-standard]
  stage: test
  script:
    - cargo test --all-targets

# ============================================================
# Security Stage (runs on dependency changes)
# ============================================================

security:audit:
  extends: [.rust-job, .validation-deps, .timeout-quick]
  stage: security
  cache:
    policy: pull  # Read-only cache
  script:
    - cargo install cargo-audit || true
    - cargo audit
