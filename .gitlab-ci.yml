# SPDX-FileCopyrightText: 2026 Mattia Egloff <mattia.egloff@pm.me>
#
# SPDX-License-Identifier: GPL-3.0-or-later

# GitLab CI for vauchi-cli
#
# Command-line interface
#
# Performance optimizations:
#   - Change-based rules: Jobs run only when relevant files change
#   - Timeouts: Prevent runaway jobs from blocking runners
#   - Read-only cache for lint jobs
#
# Pipeline strategy:
#   - MR: Validation on relevant file changes
#   - Main: No pipeline (validated via MR)
#
# Uses shared templates from vauchi/scripts for consistency.

# Include shared templates
include:
  - project: 'vauchi/scripts'
    ref: main
    file:
      - '/ci-templates/rust-base.yml'
      - '/ci-templates/security.yml'
      - '/ci-templates/mr-rules.yml'
      - '/ci-templates/reuse.yml'

stages:
  - lint
  - test
  - security

# ============================================================
# Lint Stage (runs on Rust code changes)
# ============================================================

lint:format:
  extends: [.rust-job, .validation-rust, .timeout-quick]
  stage: lint
  needs: []
  cache:
    policy: pull  # Read-only cache for lint
  script:
    - rustup component add rustfmt
    - cargo fmt --all -- --check

lint:clippy:
  extends: [.rust-job, .validation-rust, .timeout-quick]
  stage: lint
  needs: []
  cache:
    policy: pull  # Read-only cache for lint
  script:
    - rustup component add clippy
    - cargo clippy --all-targets -- -D warnings

# ============================================================
# Test Stage (runs on Rust code changes)
# ============================================================

test:unit:
  extends: [.rust-job, .validation-rust, .timeout-standard]
  stage: test
  needs: []
  script:
    - cargo test --all-targets

# ============================================================
# Security Stage (runs on dependency changes)
# ============================================================

security:audit:
  extends: [.rust-job, .validation-deps, .timeout-quick]
  stage: security
  needs: []
  cache:
    policy: pull  # Read-only cache
  script:
    - cargo install cargo-audit || true
    - cargo audit
