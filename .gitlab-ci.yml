# SPDX-FileCopyrightText: 2026 Mattia Egloff <mattia.egloff@pm.me>
#
# SPDX-License-Identifier: GPL-3.0-or-later

# GitLab CI for vauchi-cli
#
# Command-line interface
#
# Performance optimizations:
#   - Self-hosted runners: sccache, persistent caches, load-balanced
#   - Change-based rules: Jobs run only when relevant files change
#   - Timeouts: Prevent runaway jobs from blocking runners
#   - Read-only cache for lint jobs
#
# Pipeline strategy:
#   - MR: Validation on relevant file changes
#   - Upstream trigger: Verify compatibility when core merges to main
#
# Uses shared templates from vauchi/scripts for consistency.

# Include shared templates
include:
  - project: 'vauchi/scripts'
    ref: main
    file:
      - '/ci-templates/rust-base.yml'
      - '/ci-templates/security.yml'
      - '/ci-templates/mr-rules.yml'
      - '/ci-templates/downstream.yml'
      - '/ci-templates/reuse.yml'
      - '/ci-templates/test-quality.yml'

stages:
  - lint
  - test
  - mutation
  - security
  - verify

# ============================================================
# Lint Stage — Preflight Gate (runs on Rust code changes)
# ============================================================
# Cheapest checks run first. Test + security jobs wait for these
# to pass before starting (PI-13 fail-fast DAG).

lint:format:
  extends: [.rust-runner-nocache, .validation-rust, .timeout-quick]
  stage: lint
  needs: []
  script:
    - rustup component add rustfmt
    - cargo fmt --all -- --check

lint:clippy:
  extends: [.rust-runner-readonly, .validation-rust, .timeout-quick]
  stage: lint
  needs: []
  script:
    - rustup component add clippy
    - cargo clippy --all-targets -- -D warnings

# ============================================================
# Test Stage (runs on Rust code changes, gated by lint)
# ============================================================

test:coverage:
  extends: [.rust-runner, .validation-rust, .timeout-standard]
  stage: test
  needs:
    - job: lint:format
      optional: true
    - job: lint:clippy
      optional: true
  before_script:
    - !reference [.self-hosted, before_script]
    - !reference [.git-credentials, before_script]
    - rustup component add llvm-tools-preview
    - cargo binstall cargo-llvm-cov --no-confirm 2>/dev/null || cargo install cargo-llvm-cov --locked || true
  script:
    # Disable secure-storage (OS keychain) for CI — headless Linux has no
    # keyring daemon, so PlatformKeyring fails across subprocess invocations.
    # FileKeyStorage (the fallback) persists correctly in each test's TempDir.
    - cargo llvm-cov --all-targets --no-default-features --lcov --output-path lcov.info
    - cargo llvm-cov report --cobertura --output-path cobertura.xml
    - cargo llvm-cov report
  coverage: '/Total:\s+(\d+(?:\.\d+)?%)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: cobertura.xml
    paths:
      - lcov.info
      - cobertura.xml
    expire_in: 1 week

# ============================================================
# Mutation Stage (PI-02)
# ============================================================

# Nightly full mutation testing (scheduled pipeline)
mutation:nightly:
  extends: [.rust-runner, .timeout-extended]
  stage: mutation
  needs: []
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  script:
    - cargo binstall cargo-mutants --no-confirm 2>/dev/null || cargo install cargo-mutants --locked || true
    - cargo mutants --no-default-features --timeout 60 --output target/mutants
  artifacts:
    paths:
      - target/mutants/
    expire_in: 1 week

# Per-MR incremental mutation testing (advisory, runs after tests pass)
mutation:incremental:
  extends: [.rust-runner, .timeout-extended]
  stage: mutation
  needs:
    - job: test:coverage
      optional: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: true
  variables:
    GIT_DEPTH: "100"
  script:
    - cargo binstall cargo-mutants --no-confirm 2>/dev/null || cargo install cargo-mutants --locked || true
    - git fetch origin "$CI_MERGE_REQUEST_TARGET_BRANCH_NAME" --depth=100
    - git diff "origin/$CI_MERGE_REQUEST_TARGET_BRANCH_NAME"...HEAD > mr.diff
    - cargo mutants --no-default-features --in-diff mr.diff --timeout 60
  artifacts:
    paths:
      - mutants.out/
    expire_in: 1 week
    when: always

# ============================================================
# Security Stage (runs on dependency changes, gated by lint, parallel with test)
# ============================================================

security:audit:
  extends: [.rust-runner-readonly, .validation-deps, .timeout-quick]
  stage: security
  needs:
    - job: lint:format
      optional: true
    - job: lint:clippy
      optional: true
  script:
    - cargo binstall cargo-audit --no-confirm 2>/dev/null || cargo install cargo-audit || true
    - cargo audit

# Full cargo-deny check: advisories, licenses, bans, sources
security:deny:
  extends: [.rust-runner-readonly, .timeout-quick]
  stage: security
  needs:
    - job: lint:format
      optional: true
    - job: lint:clippy
      optional: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_PIPELINE_SOURCE == "schedule"
  script:
    - cargo binstall cargo-deny --no-confirm 2>/dev/null || cargo install cargo-deny || true
    - cargo deny check

# ============================================================
# Verify Stage (upstream trigger only)
# ============================================================
# Runs when core merges to main and triggers this repo via
# verify:downstream-rust. Verifies this repo builds and tests
# pass against the updated vauchi-core.

verify:upstream-compat:
  extends: [.rust-runner, .verify-on-upstream, .timeout-standard]
  stage: verify
  needs: []
  script:
    - cargo test --all-targets --no-default-features
