# GitLab CI for vauchi-cli
#
# Command-line interface
#
# GitLab Ultimate Features:
#   - SAST: Static application security testing
#   - Dependency Scanning: Cargo.lock vulnerability scanning
#   - Secret Detection: Prevent credential leaks

# GitLab Ultimate Templates
include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Dependency-Scanning.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml
  - template: Security/License-Scanning.gitlab-ci.yml

stages:
  - lint
  - test
  - security

variables:
  CARGO_HOME: ${CI_PROJECT_DIR}/.cargo
  RUST_BACKTRACE: "1"

  # GitLab Ultimate Security Configuration
  SAST_EXCLUDED_PATHS: "target/"
  DS_EXCLUDED_PATHS: "target/"
  SECRET_DETECTION_EXCLUDED_PATHS: "target/"

.rust-cache: &rust-cache
  cache:
    key: ${CI_COMMIT_REF_SLUG}-rust
    paths:
      - .cargo/bin/
      - .cargo/registry/index/
      - .cargo/registry/cache/
      - .cargo/git/db/
      - target/

.rust-job:
  image: rust:latest
  <<: *rust-cache

# ============================================================
# Lint Stage
# ============================================================

lint:format:
  extends: .rust-job
  stage: lint
  script:
    - rustup component add rustfmt
    - cargo fmt --all -- --check
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

lint:clippy:
  extends: .rust-job
  stage: lint
  script:
    - rustup component add clippy
    - cargo clippy --all-targets -- -D warnings
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
  allow_failure: true  # May fail on git dependency issues

# ============================================================
# Test Stage
# ============================================================

test:unit:
  extends: .rust-job
  stage: test
  script:
    - cargo test --all-targets
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
  allow_failure: true  # May fail on git dependency issues

# ============================================================
# Security Stage
# ============================================================

# GitLab security templates configuration
# Override child analyzer jobs (not parent stubs) to add tags and rules

semgrep-sast:
  tags: [docker]
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "schedule"

# Disable Gemnasium (doesn't support Cargo.lock well, use cargo-audit)
gemnasium-dependency_scanning:
  rules:
    - when: never

secret_detection:
  tags: [docker]
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

license_scanning:
  tags: [docker]
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

# Rust-specific security
security:audit:
  extends: .rust-job
  stage: security
  script:
    - cargo install cargo-audit || true
    - cargo audit
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "Cargo.toml"
        - "Cargo.lock"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "schedule"
  allow_failure: true
