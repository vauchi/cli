# SPDX-FileCopyrightText: 2026 Mattia Egloff <mattia.egloff@pm.me>
#
# SPDX-License-Identifier: GPL-3.0-or-later

# GitLab CI for vauchi-cli
#
# Command-line interface
#
# Pipeline strategy:
#   - MR: Full validation (lint, test, security)
#   - Main: No pipeline (validated via MR)
#
# Uses shared templates from vauchi/scripts for consistency.

# Include shared templates
include:
  - project: 'vauchi/scripts'
    ref: main
    file:
      - '/ci-templates/rust-base.yml'
      - '/ci-templates/security.yml'
      - '/ci-templates/mr-rules.yml'

stages:
  - lint
  - test
  - security

# ============================================================
# Lint Stage (MR only)
# ============================================================

lint:format:
  extends: [.rust-job, .validation-only]
  stage: lint
  script:
    - rustup component add rustfmt
    - cargo fmt --all -- --check

lint:clippy:
  extends: [.rust-job, .validation-only]
  stage: lint
  script:
    - rustup component add clippy
    - cargo clippy --all-targets -- -D warnings

# ============================================================
# Test Stage (MR only)
# ============================================================

test:unit:
  extends: [.rust-job, .validation-only]
  stage: test
  script:
    - cargo test --all-targets

# ============================================================
# Security Stage (MR only)
# ============================================================

security:audit:
  extends: [.rust-job, .validation-cargo]
  stage: security
  script:
    - cargo install cargo-audit || true
    - cargo audit
